# Koa 洋葱模型  

1. 中间件 node express koa web 服务器的模型  
  req 中间件 res  
2. 串联执行  
3. next() 向后面的中间件传递，叠加使用  
  无限可能  
  发表文章：session + route + bodyparser + error  
  浏览文章：route + 404  
4. 顺序  
5. 异步，数据库中间件，模板编译  

- 如何实现中间件的串联先后执行  
1. 串联 数据结构 栈  
2. 顺序执行 -> middlewares 数组模拟栈，每一项都是一个函数  
3. 提供一个 use 方法开启中间件 -> 检测中间件是否是函数  
4. 中间件最后会被合并成为一个函数，设计一个 app.compose() 方法，把所有的中间件合并成为一个大函数  
5. 洋葱模型的实现  
  - next 方法，不能使用 for 循环执行中间件函数  
  - 先执行第一个，由第一个中间件决定是否要继续 next 往后执行，下一个必须拿到上一个的结果 -> 递归实现  
  - dispatch 递归：  
    + 退出条件：当所有的中间件执行完毕  
    + 返回值：  
    + 本级递归要做的事情：给中间件一个 next 方法，当有 next 的时候执行下一个中间件  